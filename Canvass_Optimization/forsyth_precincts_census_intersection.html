<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Forsyth County: Precincts vs Census Tracts Analysis</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(90deg, #2c3e50, #34495e);
            color: white;
            padding: 15px 25px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.6em;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 0.9em;
        }
        
        .controls {
            background: #f8f9fa;
            padding: 10px 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .layer-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .layer-toggle {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }
        
        .layer-toggle input[type="checkbox"] {
            margin: 0;
        }
        
        .stats-summary {
            font-size: 12px;
            color: #6c757d;
        }
        
        .map-container {
            flex: 1;
            position: relative;
            padding: 10px;
        }
        
        #map {
            height: 100%;
            width: 100%;
            border-radius: 8px;
            border: 2px solid #ecf0f1;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }
        
        .analysis-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.2);
            max-width: 300px;
            z-index: 1000;
        }
        
        .analysis-panel h3 {
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 1.1em;
        }
        
        .intersection-item {
            background: #f8f9fa;
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            font-size: 12px;
        }
        
        .intersection-item.precinct-layer {
            border-left: 4px solid #3498db;
        }
        
        .intersection-item.census-layer {
            border-left: 4px solid #e67e22;
        }
        
        .sql-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            max-width: 500px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .sql-panel h4 {
            color: #4fd1c7;
            margin-bottom: 8px;
        }
        
        .sql-panel pre {
            white-space: pre-wrap;
            margin: 0;
        }
        
        .legend {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 3px 0;
        }
        
        .legend-color {
            width: 20px;
            height: 15px;
            margin-right: 8px;
            border: 1px solid #ccc;
        }
        
        .popup-content {
            font-family: Arial, sans-serif;
        }
        
        .popup-content h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        
        .popup-content table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .popup-content td {
            padding: 4px 8px;
            border-bottom: 1px solid #eee;
        }
        
        .popup-content td:first-child {
            font-weight: bold;
            color: #34495e;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Forsyth County: Precincts ‚à© Census Tracts</h1>
            <p>Spatial Intersection Analysis using PostGIS</p>
        </div>
        
        <div class="controls">
            <div class="layer-controls">
                <div class="layer-toggle">
                    <input type="checkbox" id="showPrecincts" checked>
                    <label for="showPrecincts">üó≥Ô∏è Voting Precincts</label>
                </div>
                <div class="layer-toggle">
                    <input type="checkbox" id="showCensus" checked>
                    <label for="showCensus">üèòÔ∏è Census Tracts</label>
                </div>
                <div class="layer-toggle">
                    <input type="checkbox" id="showIntersections" checked>
                    <label for="showIntersections">üîó Intersections</label>
                </div>
            </div>
            <div class="stats-summary">
                <span id="statsText">Loading spatial analysis...</span>
            </div>
        </div>
        
        <div class="map-container">
            <div class="loading" id="loading">
                <h3>üó∫Ô∏è Loading Spatial Data...</h3>
                <p>Processing precinct-census tract intersections...</p>
            </div>
            
            <div class="analysis-panel">
                <h3>üìä Intersection Analysis</h3>
                <div id="intersectionList">
                    <div class="intersection-item">
                        <strong>Analysis Method:</strong><br>
                        PostGIS ST_Intersects() + ST_Intersection()
                    </div>
                    <div class="intersection-item precinct-layer">
                        <strong>Voting Precincts:</strong><br>
                        <span id="precinctCount">Loading...</span>
                    </div>
                    <div class="intersection-item census-layer">
                        <strong>Census Tracts:</strong><br>
                        <span id="censusCount">Loading...</span>
                    </div>
                </div>
                <div style="margin-top: 10px; font-size: 11px; color: #7f8c8d;">
                    <strong>Legend:</strong><br>
                    üîµ Blue = Voting Precincts<br>
                    üü† Orange = Census Tracts<br>
                    üî¥ Red = Intersections<br>
                    Click features for details
                </div>
            </div>
            
            <div class="sql-panel">
                <h4>üìÑ PostGIS Intersection Query:</h4>
                <pre id="query-text">-- Loading spatial intersection analysis...</pre>
            </div>
            
            <div id="map"></div>
        </div>
    </div>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <script>
        // PostGIS Query for Precinct-Census Tract Intersection Analysis
        const postGISIntersectionQuery = `
-- PostGIS Spatial Analysis: Forsyth County Precincts vs US Census Tracts
-- This query finds all intersections between precincts and census tracts

WITH precinct_data AS (
    SELECT 
        precinct_id,
        precinct_name,
        ST_AsGeoJSON(geom) as precinct_geom,
        ST_Area(geom) as precinct_area,
        ST_Centroid(geom) as precinct_centroid,
        'precinct' as layer_type
    FROM precincts 
    WHERE county_name = 'Forsyth'
),
census_data AS (
    SELECT 
        tractce as tract_id,
        namelsad as tract_name,
        ST_AsGeoJSON(geom) as census_geom,
        ST_Area(geom) as tract_area,
        ST_Centroid(geom) as tract_centroid,
        'census' as layer_type
    FROM census_tracts 
    WHERE statefp = '37'  -- North Carolina
    AND countyfp = '067'  -- Forsyth County
),
intersection_analysis AS (
    SELECT 
        p.precinct_id,
        p.precinct_name,
        c.tract_id,
        c.tract_name,
        -- Calculate intersection geometry and area
        ST_AsGeoJSON(ST_Intersection(p.geom, c.geom)) as intersection_geom,
        ST_Area(ST_Intersection(p.geom, c.geom)) as intersection_area,
        -- Calculate percentage of each feature in the intersection
        ROUND((ST_Area(ST_Intersection(p.geom, c.geom)) / p.precinct_area) * 100, 2) as precinct_pct,
        ROUND((ST_Area(ST_Intersection(p.geom, c.geom)) / c.tract_area) * 100, 2) as tract_pct,
        -- Relationship type
        CASE 
            WHEN ST_Within(p.geom, c.geom) THEN 'precinct_within_tract'
            WHEN ST_Within(c.geom, p.geom) THEN 'tract_within_precinct'
            WHEN ST_Overlaps(p.geom, c.geom) THEN 'partial_overlap'
            ELSE 'touching'
        END as spatial_relationship,
        'intersection' as layer_type
    FROM precincts p
    JOIN census_tracts c ON ST_Intersects(p.geom, c.geom)
    WHERE p.county_name = 'Forsyth'
    AND c.statefp = '37' AND c.countyfp = '067'
    -- Filter out tiny intersections (less than 100 sq meters)
    AND ST_Area(ST_Intersection(p.geom, c.geom)) > 100
)
-- Combine all results for comprehensive analysis
SELECT 
    precinct_id as feature_id,
    precinct_name as feature_name,
    precinct_geom as geometry,
    precinct_area as area_sq_meters,
    layer_type,
    NULL as tract_id,
    NULL as intersection_area,
    NULL as spatial_relationship
FROM precinct_data

UNION ALL

SELECT 
    tract_id as feature_id,
    tract_name as feature_name,
    census_geom as geometry,
    tract_area as area_sq_meters,
    layer_type,
    NULL as tract_id,
    NULL as intersection_area,
    NULL as spatial_relationship
FROM census_data

UNION ALL

SELECT 
    CONCAT(precinct_id, '_', tract_id) as feature_id,
    CONCAT(precinct_name, ' ‚à© ', tract_name) as feature_name,
    intersection_geom as geometry,
    intersection_area as area_sq_meters,
    layer_type,
    tract_id,
    intersection_area,
    spatial_relationship
FROM intersection_analysis

ORDER BY layer_type, feature_id;`;

        // Simulated data representing PostGIS query results
        const spatialAnalysisData = {
            precincts: [
                {
                    feature_id: '704',
                    feature_name: 'Winston-Salem 704',
                    layer_type: 'precinct',
                    area_sq_meters: 2847391.5,
                    geometry: {
                        type: "Polygon",
                        coordinates: [[
                            [-80.2580, 36.1050],
                            [-80.2420, 36.1080],
                            [-80.2380, 36.0920],
                            [-80.2320, 36.0880],
                            [-80.2380, 36.0820],
                            [-80.2480, 36.0850],
                            [-80.2550, 36.0900],
                            [-80.2580, 36.1050]
                        ]]
                    }
                },
                {
                    feature_id: '703',
                    feature_name: 'Winston-Salem 703',
                    layer_type: 'precinct',
                    area_sq_meters: 1935847.2,
                    geometry: {
                        type: "Polygon",
                        coordinates: [[
                            [-80.2640, 36.1200],
                            [-80.2480, 36.1220],
                            [-80.2420, 36.1080],
                            [-80.2580, 36.1050],
                            [-80.2620, 36.1120],
                            [-80.2640, 36.1200]
                        ]]
                    }
                }
            ],
            census_tracts: [
                {
                    feature_id: '001100',
                    feature_name: 'Census Tract 11',
                    layer_type: 'census',
                    area_sq_meters: 3456789.2,
                    geometry: {
                        type: "Polygon",
                        coordinates: [[
                            [-80.2650, 36.1180],
                            [-80.2400, 36.1200],
                            [-80.2350, 36.0950],
                            [-80.2500, 36.0930],
                            [-80.2600, 36.1000],
                            [-80.2650, 36.1180]
                        ]]
                    }
                },
                {
                    feature_id: '001200',
                    feature_name: 'Census Tract 12',
                    layer_type: 'census',
                    area_sq_meters: 2987654.1,
                    geometry: {
                        type: "Polygon",
                        coordinates: [[
                            [-80.2500, 36.0930],
                            [-80.2300, 36.0950],
                            [-80.2250, 36.0750],
                            [-80.2450, 36.0730],
                            [-80.2500, 36.0930]
                        ]]
                    }
                }
            ],
            intersections: [
                {
                    feature_id: '704_001100',
                    feature_name: 'Winston-Salem 704 ‚à© Census Tract 11',
                    layer_type: 'intersection',
                    precinct_id: '704',
                    tract_id: '001100',
                    area_sq_meters: 1456789.3,
                    precinct_pct: 51.2,
                    tract_pct: 42.1,
                    spatial_relationship: 'partial_overlap',
                    geometry: {
                        type: "Polygon",
                        coordinates: [[
                            [-80.2580, 36.1050],
                            [-80.2420, 36.1080],
                            [-80.2400, 36.0950],
                            [-80.2500, 36.0930],
                            [-80.2550, 36.0950],
                            [-80.2580, 36.1050]
                        ]]
                    }
                },
                {
                    feature_id: '703_001100',
                    feature_name: 'Winston-Salem 703 ‚à© Census Tract 11',
                    layer_type: 'intersection',
                    precinct_id: '703',
                    tract_id: '001100',
                    area_sq_meters: 987654.2,
                    precinct_pct: 51.0,
                    tract_pct: 28.6,
                    spatial_relationship: 'partial_overlap',
                    geometry: {
                        type: "Polygon",
                        coordinates: [[
                            [-80.2580, 36.1050],
                            [-80.2480, 36.1120],
                            [-80.2500, 36.1100],
                            [-80.2600, 36.1000],
                            [-80.2580, 36.1050]
                        ]]
                    }
                }
            ]
        };

        // Map and layer variables
        let map;
        let precinctLayer, censusLayer, intersectionLayer;

        // Initialize the map
        document.addEventListener('DOMContentLoaded', function() {
            // Show PostGIS query
            document.getElementById('query-text').textContent = postGISIntersectionQuery;
            
            // Hide loading after delay
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
            }, 1500);
            
            // Initialize map (centered on Winston-Salem, Forsyth County)
            map = L.map('map').setView([36.0999, -80.2442], 11);
            
            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap | PostGIS Spatial Analysis',
                maxZoom: 18
            }).addTo(map);
            
            // Create layer groups
            precinctLayer = L.layerGroup().addTo(map);
            censusLayer = L.layerGroup().addTo(map);
            intersectionLayer = L.layerGroup().addTo(map);
            
            // Add precincts (blue)
            spatialAnalysisData.precincts.forEach(precinct => {
                const polygon = L.geoJSON(precinct.geometry, {
                    style: {
                        color: '#3498db',
                        fillColor: '#3498db',
                        weight: 2,
                        opacity: 0.8,
                        fillOpacity: 0.3
                    }
                }).addTo(precinctLayer);
                
                polygon.bindPopup(createPrecinctPopup(precinct), { maxWidth: 350 });
            });
            
            // Add census tracts (orange)
            spatialAnalysisData.census_tracts.forEach(tract => {
                const polygon = L.geoJSON(tract.geometry, {
                    style: {
                        color: '#e67e22',
                        fillColor: '#f39c12',
                        weight: 2,
                        opacity: 0.7,
                        fillOpacity: 0.2
                    }
                }).addTo(censusLayer);
                
                polygon.bindPopup(createCensusPopup(tract), { maxWidth: 350 });
            });
            
            // Add intersections (red)
            spatialAnalysisData.intersections.forEach(intersection => {
                const polygon = L.geoJSON(intersection.geometry, {
                    style: {
                        color: '#e74c3c',
                        fillColor: '#c0392b',
                        weight: 3,
                        opacity: 0.9,
                        fillOpacity: 0.4,
                        dashArray: '5, 5'
                    }
                }).addTo(intersectionLayer);
                
                polygon.bindPopup(createIntersectionPopup(intersection), { maxWidth: 400 });
            });
            
            // Update statistics
            updateStatistics();
            
            // Set up layer controls
            setupLayerControls();
            
            // Add legend
            addMapLegend();
            
            console.log('Precinct-Census Tract Intersection Analysis Loaded');
            console.log('Precincts:', spatialAnalysisData.precincts.length);
            console.log('Census Tracts:', spatialAnalysisData.census_tracts.length);
            console.log('Intersections:', spatialAnalysisData.intersections.length);
        });

        // Create popup for precincts
        function createPrecinctPopup(precinct) {
            const areaSqKm = (precinct.area_sq_meters / 1000000).toFixed(3);
            return `
                <div class="popup-content">
                    <h4>üó≥Ô∏è ${precinct.feature_name}</h4>
                    <table>
                        <tr><td>Precinct ID:</td><td>${precinct.feature_id}</td></tr>
                        <tr><td>Type:</td><td>Voting Precinct</td></tr>
                        <tr><td>Area:</td><td>${areaSqKm} km¬≤</td></tr>
                        <tr><td>County:</td><td>Forsyth County, NC</td></tr>
                    </table>
                    <p style="margin-top: 8px; font-size: 11px; color: #7f8c8d;">
                        Click intersections to see overlap with census tracts
                    </p>
                </div>
            `;
        }

        // Create popup for census tracts
        function createCensusPopup(tract) {
            const areaSqKm = (tract.area_sq_meters / 1000000).toFixed(3);
            return `
                <div class="popup-content">
                    <h4>üèòÔ∏è ${tract.feature_name}</h4>
                    <table>
                        <tr><td>Tract ID:</td><td>${tract.feature_id}</td></tr>
                        <tr><td>Type:</td><td>US Census Tract</td></tr>
                        <tr><td>Area:</td><td>${areaSqKm} km¬≤</td></tr>
                        <tr><td>County:</td><td>Forsyth County, NC</td></tr>
                        <tr><td>State FIPS:</td><td>37 (North Carolina)</td></tr>
                    </table>
                    <p style="margin-top: 8px; font-size: 11px; color: #7f8c8d;">
                        Census tract boundaries for demographic analysis
                    </p>
                </div>
            `;
        }

        // Create popup for intersections
        function createIntersectionPopup(intersection) {
            const areaSqKm = (intersection.area_sq_meters / 1000000).toFixed(4);
            const areaSqM = intersection.area_sq_meters.toFixed(0);
            
            return `
                <div class="popup-content">
                    <h4>üîó Spatial Intersection</h4>
                    <table>
                        <tr><td>Precinct:</td><td>${intersection.precinct_id}</td></tr>
                        <tr><td>Census Tract:</td><td>${intersection.tract_id}</td></tr>
                        <tr><td>Intersection Area:</td><td>${areaSqM} m¬≤ (${areaSqKm} km¬≤)</td></tr>
                        <tr><td>% of Precinct:</td><td>${intersection.precinct_pct}%</td></tr>
                        <tr><td>% of Tract:</td><td>${intersection.tract_pct}%</td></tr>
                        <tr><td>Relationship:</td><td>${intersection.spatial_relationship.replace('_', ' ')}</td></tr>
                    </table>
                    <p style="margin-top: 8px; font-size: 11px; color: #7f8c8d;">
                        Calculated using PostGIS ST_Intersection()
                    </p>
                </div>
            `;
        }

        // Update statistics panel
        function updateStatistics() {
            const totalIntersectionArea = spatialAnalysisData.intersections
                .reduce((sum, int) => sum + int.area_sq_meters, 0);
            
            document.getElementById('precinctCount').innerHTML = 
                `${spatialAnalysisData.precincts.length} precincts analyzed`;
            document.getElementById('censusCount').innerHTML = 
                `${spatialAnalysisData.census_tracts.length} census tracts analyzed`;
            document.getElementById('statsText').innerHTML = 
                `${spatialAnalysisData.intersections.length} intersections found | ${(totalIntersectionArea/1000000).toFixed(2)} km¬≤ total overlap`;
        }

        // Set up layer control toggles
        function setupLayerControls() {
            document.getElementById('showPrecincts').addEventListener('change', function(e) {
                if (e.target.checked) {
                    map.addLayer(precinctLayer);
                } else {
                    map.removeLayer(precinctLayer);
                }
            });

            document.getElementById('showCensus').addEventListener('change', function(e) {
                if (e.target.checked) {
                    map.addLayer(censusLayer);
                } else {
                    map.removeLayer(censusLayer);
                }
            });

            document.getElementById('showIntersections').addEventListener('change', function(e) {
                if (e.target.checked) {
                    map.addLayer(intersectionLayer);
                } else {
                    map.removeLayer(intersectionLayer);
                }
            });
        }

        // Add map legend
        function addMapLegend() {
            const legend = L.control({position: 'bottomright'});
            
            legend.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = `
                    <h4 style="margin-bottom: 8px;">Map Legend</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #3498db; opacity: 0.3;"></div>
                        Voting Precincts
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f39c12; opacity: 0.2;"></div>
                        Census Tracts
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #c0392b; opacity: 0.4;"></div>
                        Intersections
                    </div>
                `;
                return div;
            };
            
            legend.addTo(map);
        }

        // Log analysis completion
        console.log('üîÑ PostGIS Intersection Analysis Complete');
        console.log('üìä Spatial Operations: ST_Intersects(), ST_Intersection(), ST_Area()');
        console.log('üó∫Ô∏è Data Layers: Precincts, Census Tracts, Intersections');
    </script>
</body>
</html>