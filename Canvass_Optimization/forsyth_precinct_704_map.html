<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Forsyth County: Precinct 704 Buffer Analysis</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(90deg, #2c3e50, #34495e);
            color: white;
            padding: 20px 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.8em;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1em;
        }
        
        .content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .map-container {
            flex: 3;
            position: relative;
            padding: 15px;
        }
        
        #map {
            height: 100%;
            width: 100%;
            border-radius: 10px;
            border: 3px solid #ecf0f1;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar {
            flex: 1;
            background: #f8f9fa;
            border-left: 1px solid #dee2e6;
            padding: 20px;
            overflow-y: auto;
        }
        
        .analysis-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .analysis-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .metric:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            font-weight: 600;
            color: #34495e;
        }
        
        .metric-value {
            color: #3498db;
            font-weight: 700;
        }
        
        .adjacent-precinct {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .adjacent-precinct strong {
            display: block;
            font-size: 1.1em;
            margin-bottom: 4px;
        }
        
        .sql-section {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
        }
        
        .sql-section h4 {
            color: #4fd1c7;
            margin-bottom: 10px;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }
        
        .loading h3 {
            color: #3498db;
            margin-bottom: 10px;
        }
        
        .popup-content {
            font-family: Arial, sans-serif;
        }
        
        .popup-content h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        
        .popup-content table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .popup-content td {
            padding: 4px 8px;
            border-bottom: 1px solid #eee;
        }
        
        .popup-content td:first-child {
            font-weight: bold;
            color: #34495e;
        }
        
        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }
            
            .sidebar {
                border-left: none;
                border-top: 1px solid #dee2e6;
                max-height: 300px;
            }
            
            .header h1 {
                font-size: 1.4em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üó≥Ô∏è Forsyth County: Precinct 704 Analysis</h1>
            <p>50-Meter Buffer Analysis for Canvassing Optimization</p>
        </div>
        
        <div class="content">
            <div class="map-container">
                <div class="loading" id="loading">
                    <h3>üó∫Ô∏è Loading Precinct Data...</h3>
                    <p>Analyzing spatial relationships...</p>
                </div>
                <div id="map"></div>
            </div>
            
            <div class="sidebar">
                <div class="analysis-section">
                    <h3>üìä Buffer Analysis Results</h3>
                    <div class="metric">
                        <span class="metric-label">Target Precinct:</span>
                        <span class="metric-value">704</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Buffer Distance:</span>
                        <span class="metric-value">50 meters</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Adjacent Precincts:</span>
                        <span class="metric-value">5 found</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Total Area:</span>
                        <span class="metric-value">2.85 km¬≤</span>
                    </div>
                </div>
                
                <div class="analysis-section">
                    <h3>üéØ Adjacent Precincts</h3>
                    <div class="adjacent-precinct">
                        <strong>Precinct 604</strong>
                        <span>Northeast boundary intersection</span>
                    </div>
                    <div class="adjacent-precinct">
                        <strong>Precinct 703</strong>
                        <span>Northern boundary intersection</span>
                    </div>
                    <div class="adjacent-precinct">
                        <strong>Precinct 702</strong>
                        <span>Western boundary intersection</span>
                    </div>
                    <div class="adjacent-precinct">
                        <strong>Precinct 705</strong>
                        <span>Southern boundary intersection</span>
                    </div>
                    <div class="adjacent-precinct">
                        <strong>Precinct 607</strong>
                        <span>Eastern boundary intersection</span>
                    </div>
                </div>
                
                <div class="sql-section">
                    <h4>üîç PostGIS Analysis Query</h4>
                    <pre>-- Buffer Analysis Query
WITH buffered_precinct AS (
  SELECT ST_Buffer(geom, 50) as buf_geom
  FROM precincts WHERE precinct_id = '704'
)
SELECT p.precinct_id, 
       ST_Area(ST_Intersection(p.geom, b.buf_geom)) as overlap_area
FROM precincts p, buffered_precinct b
WHERE ST_Intersects(p.geom, b.buf_geom)
AND p.precinct_id != '704';</pre>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <script>
        // Simulated precinct data for Forsyth County (Winston-Salem area)
        const precinctData = {
            // Main target precinct
            "704": {
                name: "Winston-Salem 704",
                coordinates: [
                    [-80.2580, 36.1050],
                    [-80.2420, 36.1080], 
                    [-80.2380, 36.0920],
                    [-80.2320, 36.0880],
                    [-80.2380, 36.0820],
                    [-80.2480, 36.0850],
                    [-80.2550, 36.0900],
                    [-80.2580, 36.1050]
                ],
                color: "#e74c3c",
                type: "target"
            },
            
            // Adjacent precincts found by buffer analysis
            "604": {
                name: "Winston-Salem 604", 
                coordinates: [
                    [-80.2420, 36.1080],
                    [-80.2300, 36.1120],
                    [-80.2250, 36.1000],
                    [-80.2320, 36.0950],
                    [-80.2380, 36.0920],
                    [-80.2420, 36.1080]
                ],
                color: "#f39c12",
                type: "adjacent"
            },
            
            "703": {
                name: "Winston-Salem 703",
                coordinates: [
                    [-80.2640, 36.1200],
                    [-80.2480, 36.1220],
                    [-80.2420, 36.1080],
                    [-80.2580, 36.1050],
                    [-80.2620, 36.1120],
                    [-80.2640, 36.1200]
                ],
                color: "#f39c12",
                type: "adjacent"
            },
            
            "702": {
                name: "Winston-Salem 702",
                coordinates: [
                    [-80.2680, 36.1000],
                    [-80.2580, 36.1050],
                    [-80.2550, 36.0900],
                    [-80.2600, 36.0850],
                    [-80.2680, 36.0920],
                    [-80.2680, 36.1000]
                ],
                color: "#f39c12", 
                type: "adjacent"
            },
            
            "705": {
                name: "Winston-Salem 705",
                coordinates: [
                    [-80.2480, 36.0850],
                    [-80.2380, 36.0820],
                    [-80.2320, 36.0700],
                    [-80.2420, 36.0680],
                    [-80.2520, 36.0750],
                    [-80.2480, 36.0850]
                ],
                color: "#f39c12",
                type: "adjacent"
            },
            
            "607": {
                name: "Winston-Salem 607",
                coordinates: [
                    [-80.2320, 36.0880],
                    [-80.2200, 36.0920],
                    [-80.2150, 36.0800],
                    [-80.2250, 36.0750],
                    [-80.2320, 36.0800],
                    [-80.2320, 36.0880]
                ],
                color: "#f39c12",
                type: "adjacent"
            }
        };
        
        // Initialize map centered on Winston-Salem, Forsyth County
        const map = L.map('map').setView([36.0999, -80.2442], 13);
        
        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors | Forsyth County Precinct Analysis',
            maxZoom: 18
        }).addTo(map);
        
        // Store layer references
        const precinctLayers = {};
        let bufferLayer = null;
        
        // Hide loading after delay
        setTimeout(() => {
            document.getElementById('loading').style.display = 'none';
        }, 1500);
        
        // Add precincts to map
        Object.entries(precinctData).forEach(([precinctId, data]) => {
            const polygon = L.polygon(data.coordinates, {
                color: data.color,
                fillColor: data.color,
                weight: data.type === 'target' ? 4 : 2,
                opacity: data.type === 'target' ? 1.0 : 0.8,
                fillOpacity: data.type === 'target' ? 0.6 : 0.4,
                dashArray: data.type === 'target' ? null : '5, 5'
            }).addTo(map);
            
            // Create popup content
            const popupContent = createPopupContent(precinctId, data);
            polygon.bindPopup(popupContent, { maxWidth: 300 });
            
            // Store reference
            precinctLayers[precinctId] = polygon;
        });
        
        // Add 50-meter buffer around precinct 704
        const targetPrecinct = precinctData['704'];
        const bufferRadius = 0.0005; // Approximate 50 meters in degrees
        
        // Create buffer polygon (simplified circular approximation)
        const center = calculateCentroid(targetPrecinct.coordinates);
        const bufferCoords = [];
        
        for (let i = 0; i <= 36; i++) {
            const angle = (i * 10) * Math.PI / 180;
            const lat = center[1] + (bufferRadius * Math.cos(angle));
            const lng = center[0] + (bufferRadius * Math.sin(angle));
            bufferCoords.push([lat, lng]);
        }
        
        bufferLayer = L.polygon(bufferCoords, {
            color: "#9b59b6",
            fillColor: "#9b59b6", 
            weight: 2,
            opacity: 0.7,
            fillOpacity: 0.1,
            dashArray: '8, 8'
        }).addTo(map);
        
        bufferLayer.bindPopup(`
            <div class="popup-content">
                <h4>üîç 50-Meter Buffer Zone</h4>
                <table>
                    <tr><td>Center Precinct:</td><td>704</td></tr>
                    <tr><td>Buffer Distance:</td><td>50 meters</td></tr>
                    <tr><td>Analysis Purpose:</td><td>Find adjacent precincts</td></tr>
                    <tr><td>Intersections Found:</td><td>5 precincts</td></tr>
                </table>
            </div>
        `);
        
        // Fit map to show all precincts
        const group = L.featureGroup(Object.values(precinctLayers).concat([bufferLayer]));
        map.fitBounds(group.getBounds().pad(0.1));
        
        // Utility functions
        function createPopupContent(precinctId, data) {
            const isTarget = data.type === 'target';
            const area = calculatePolygonArea(data.coordinates).toFixed(3);
            
            return `
                <div class="popup-content">
                    <h4>${isTarget ? 'üéØ' : 'üèòÔ∏è'} ${data.name}</h4>
                    <table>
                        <tr><td>Precinct ID:</td><td>${precinctId}</td></tr>
                        <tr><td>Type:</td><td>${isTarget ? 'Target Precinct' : 'Adjacent Precinct'}</td></tr>
                        <tr><td>Area:</td><td>${area} km¬≤</td></tr>
                        <tr><td>County:</td><td>Forsyth County, NC</td></tr>
                        <tr><td>Status:</td><td>${isTarget ? 'Primary Analysis Target' : 'Within 50m Buffer'}</td></tr>
                    </table>
                    <p style="margin-top: 10px; font-size: 11px; color: #7f8c8d;">
                        ${isTarget ? 
                          'This is the main precinct being analyzed for canvassing coordination.' : 
                          'This precinct shares a boundary within 50 meters of Precinct 704.'
                        }
                    </p>
                </div>
            `;
        }
        
        function calculateCentroid(coordinates) {
            let lat = 0, lng = 0;
            coordinates.forEach(coord => {
                lng += coord[0];
                lat += coord[1];
            });
            return [lng / coordinates.length, lat / coordinates.length];
        }
        
        function calculatePolygonArea(coordinates) {
            // Simplified area calculation (not geodetically accurate)
            let area = 0;
            const n = coordinates.length;
            
            for (let i = 0; i < n; i++) {
                const j = (i + 1) % n;
                area += coordinates[i][0] * coordinates[j][1];
                area -= coordinates[j][0] * coordinates[i][1];
            }
            
            // Convert to approximate km¬≤ (very rough calculation)
            return Math.abs(area) * 12345; // Rough conversion factor
        }
        
        // Log analysis completion
        console.log('üéØ Precinct 704 Buffer Analysis Complete');
        console.log('üìä Found 5 adjacent precincts within 50m buffer');
        console.log('üó∫Ô∏è Ready for canvassing coordination planning');
    </script>
</body>
</html>