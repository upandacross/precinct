{% extends "base.html" %}
{% block title %}Past Race Analysis - Precinct Member's Application{% endblock %}

{% block content %}
<!-- Overall Assessment Summary -->
<div class="container-fluid px-3 mb-4">
    <div class="row g-3 mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0">
                                <i class="fas fa-chart-pie"></i> Historical Race Flippability Analysis
                            </h5>
                            <p class="mb-0 mt-2"><small><i class="fas fa-info-circle"></i> Analyzing past races (2020-2024) to identify patterns. Future enhancement will correlate with current ballot races.</small></p>
                        </div>
                        <div>
                            <button type="button" class="btn fw-bold" data-bs-toggle="modal" data-bs-target="#strategyModal" style="background-color: #dc3545 !important; border-color: #dc3545 !important; color: white !important;">
                                <i class="fas fa-lightbulb"></i> Flippability and Future Races
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 col-md-3 mb-2">
                            <div class="bg-success text-white rounded p-3">
                                <h3 class="mb-1">{{ total_assessment_counts['ðŸŽ¯ SLAM DUNK'] }}</h3>
                                <strong>ðŸŽ¯ SLAM DUNK (PAST)</strong><br>
                                <small>Weekend volunteer effort</small>
                            </div>
                        </div>
                        <div class="col-6 col-md-3 mb-2">
                            <div class="bg-info text-white rounded p-3">
                                <h3 class="mb-1">{{ total_assessment_counts['âœ… HIGHLY FLIPPABLE'] }}</h3>
                                <strong>âœ… HIGHLY FLIPPABLE (PAST)</strong><br>
                                <small>Month-long focused campaign</small>
                            </div>
                        </div>
                        <div class="col-6 col-md-3 mb-2">
                            <div class="bg-warning text-white rounded p-3">
                                <h3 class="mb-1">{{ total_assessment_counts['ðŸŸ¡ COMPETITIVE'] }}</h3>
                                <strong>ðŸŸ¡ COMPETITIVE (PAST)</strong><br>
                                <small>Season-long strategic effort</small>
                            </div>
                        </div>
                        <div class="col-6 col-md-3 mb-2">
                            <div class="bg-danger text-white rounded p-3">
                                <h3 class="mb-1">{{ total_assessment_counts['ðŸ”´ STRETCH GOAL'] }}</h3>
                                <strong>ðŸ”´ STRETCH GOAL (PAST)</strong><br>
                                <small>Multi-cycle investment</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Precinct Summary Table -->
<div class="container-fluid px-3 mb-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-table"></i> Precinct Historical Race Analysis Summary
                    </h4>
                    <small class="text-muted">Past race assessments by precinct (2020-2024) - Click any row to view detailed races for that precinct</small>
                </div>
                <div class="card-body p-0">
                    {% if precinct_summaries %}
                        <div class="table-responsive">
                            <table class="table table-hover table-striped mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>County</th>
                                        <th>Precinct</th>
                                        <th class="text-center">ðŸŽ¯ Slam Dunk</th>
                                        <th class="text-center">âœ… Highly Flippable</th>
                                        <th class="text-center">ðŸŸ¡ Competitive</th>
                                        <th class="text-center">ðŸ”´ Stretch Goal</th>
                                        <th class="text-center">Total Races</th>
                                        <th class="text-center">Total Vote Gap</th>
                                        <th class="text-center">Avg DVA %</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for precinct_key, precinct in precinct_summaries %}
                                        <tr class="clickable-row" 
                                            data-county="{{ precinct.county }}" 
                                            data-precinct="{{ precinct.precinct }}"
                                            style="cursor: pointer;"
                                            title="Click to view detailed analysis for {{ precinct.county }} County, Precinct {{ precinct.precinct }}">
                                            <td><strong>{{ precinct.county }}</strong></td>
                                            <td><strong>{{ precinct.precinct }}</strong></td>
                                            <td class="text-center">
                                                <span class="badge bg-success">{{ precinct['ðŸŽ¯ SLAM DUNK'] }}</span>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-info">{{ precinct['âœ… HIGHLY FLIPPABLE'] }}</span>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-warning">{{ precinct['ðŸŸ¡ COMPETITIVE'] }}</span>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-danger">{{ precinct['ðŸ”´ STRETCH GOAL'] }}</span>
                                            </td>
                                            <td class="text-center">
                                                <strong>{{ precinct.total_races }}</strong>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge {% if precinct.total_vote_gap <= 100 %}bg-success{% elif precinct.total_vote_gap <= 500 %}bg-warning{% else %}bg-danger{% endif %}">
                                                    {{ precinct.total_vote_gap }}
                                                </span>
                                            </td>
                                            <td class="text-center">
                                                {% if precinct.avg_dva != 'N/A' %}
                                                    <span class="badge {% if precinct.avg_dva <= 25 %}bg-success{% elif precinct.avg_dva <= 50 %}bg-warning{% else %}bg-danger{% endif %}">
                                                        {{ precinct.avg_dva }}%
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-secondary">{{ precinct.avg_dva }}</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center p-4">
                            <i class="fas fa-info-circle text-muted fa-3x mb-3"></i>
                            <p class="text-muted">No flippable races data available for your scope.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Back to Dashboard Button -->
<div class="container-fluid px-3 mb-4">
    <div class="row">
        <div class="col-12 text-center">
            <a href="{{ url_for('index') }}" class="btn btn-secondary btn-lg">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>
</div>

<!-- Ballot Matching Strategy Modal -->
<div class="modal fade" id="strategyModal" tabindex="-1" aria-labelledby="strategyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="text-shadow: none;">
                <h5 class="modal-title text-dark" id="strategyModalLabel" style="text-shadow: none;">
                    <i class="fas fa-map-marked-alt"></i> Ballot Matching Strategy
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-dark" id="strategyContent" style="text-shadow: none; max-height: 70vh; overflow-y: auto;">
                {{ strategy_content|safe }}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add click handlers to table rows
    const clickableRows = document.querySelectorAll('.clickable-row');
    
    clickableRows.forEach(row => {
        row.addEventListener('click', function() {
            const county = this.dataset.county;
            const precinct = this.dataset.precinct;
            
            // Create a form to submit the county and precinct data to the flippable page
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for("flippable_races") }}';
            
            const countyInput = document.createElement('input');
            countyInput.type = 'hidden';
            countyInput.name = 'analysis_county';
            countyInput.value = county;
            
            const precinctInput = document.createElement('input');
            precinctInput.type = 'hidden';
            precinctInput.name = 'analysis_precinct';
            precinctInput.value = precinct;
            
            form.appendChild(countyInput);
            form.appendChild(precinctInput);
            document.body.appendChild(form);
            form.submit();
        });
        
        // Add hover effect
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#e8f4f8';
        });
        
        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
        });
    });
});
</script>

{% endblock %}