{% extends "base.html" %}

{% block title %}Clustering Analysis - Precinct Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-project-diagram"></i> Clustering Analysis</h1>
        <p class="lead">Strategic insights from precinct and demographic clustering analysis</p>
    </div>
</div>

<!-- User Precinct Insights -->
{% if user_insights %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-map-marker-alt"></i> Your Precinct: {{ user_insights.county }} - {{ user_insights.precinct }}</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="stat-box text-center">
                            <h3 class="text-primary">{{ user_insights.comprehensive_cluster }}</h3>
                            <p class="text-muted">Cluster Assignment</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-box text-center">
                            <h3 class="text-info">{{ "%.1f"|format(user_insights.area_km2) }}</h3>
                            <p class="text-muted">Area (kmÂ²)</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-box text-center">
                            <h3 class="text-success">{{ "%.0f"|format(user_insights.flippability_score) }}</h3>
                            <p class="text-muted">Flippability Score</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-box text-center">
                            {% if user_insights.strategic_priority.startswith('Tier 1') %}
                                <span class="badge bg-danger fs-6">HIGH PRIORITY</span>
                            {% elif user_insights.strategic_priority.startswith('Tier 2') %}
                                <span class="badge bg-warning fs-6">MEDIUM PRIORITY</span>
                            {% else %}
                                <span class="badge bg-info fs-6">DATA TARGET</span>
                            {% endif %}
                            <p class="text-muted mt-2">Strategic Priority</p>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <strong>Strategic Classification:</strong> {{ user_insights.strategic_priority }}
                            <br>
                            <strong>Data Availability:</strong> 
                            {% if user_insights.has_political_data and user_insights.has_flippable_data %}
                                Complete data available (Political + Flippable)
                            {% elif user_insights.has_political_data %}
                                Political data available
                            {% else %}
                                Spatial data only
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i> 
            Your precinct information is not available in the clustering analysis. 
            Please ensure your profile has correct precinct and county information.
        </div>
    </div>
</div>
{% endif %}

<!-- Overall Summary -->
{% if cluster_summary %}
<div class="row mt-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-pie"></i> Clustering Overview</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 text-center">
                        <h4 class="text-primary">{{ cluster_summary.total_precincts }}</h4>
                        <p class="text-muted">Total Precincts</p>
                    </div>
                    <div class="col-md-3 text-center">
                        <h4 class="text-success">{{ cluster_summary.high_priority_precincts }}</h4>
                        <p class="text-muted">High Priority</p>
                    </div>
                    <div class="col-md-3 text-center">
                        <h4 class="text-info">{{ cluster_summary.precincts_with_political_data }}</h4>
                        <p class="text-muted">With Political Data</p>
                    </div>
                    <div class="col-md-3 text-center">
                        <h4 class="text-warning">{{ cluster_summary.precincts_with_flippable_data }}</h4>
                        <p class="text-muted">With Flippable Data</p>
                    </div>
                </div>
                
                <!-- Cluster Distribution Chart -->
                <div class="mt-4">
                    <canvas id="clusterChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-bullseye"></i> Strategic Actions</h5>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    <div class="list-group-item">
                        <strong>Tier 1 Priority:</strong><br>
                        <small>Clusters 3, 5, 6 - Complete data</small>
                    </div>
                    <div class="list-group-item">
                        <strong>Tier 2 Priority:</strong><br>
                        <small>Cluster 1 - Largest segment</small>
                    </div>
                    <div class="list-group-item">
                        <strong>Tier 3 Opportunity:</strong><br>
                        <small>Data collection targets</small>
                    </div>
                </div>
                
                <div class="mt-3">
                    <a href="/doc/PRECINCT_CLUSTERING_SUMMARY.md" 
                       class="btn btn-outline-primary btn-sm" target="_blank">
                        <i class="fas fa-file-alt"></i> Full Analysis Report
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- County Insights -->
{% if county_insights %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-map"></i> {{ user.county }} County Analysis</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 text-center">
                        <h4>{{ county_insights.total_precincts }}</h4>
                        <p class="text-muted">County Precincts</p>
                    </div>
                    <div class="col-md-3 text-center">
                        <h4>{{ county_insights.priority_precincts }}</h4>
                        <p class="text-muted">Priority Targets</p>
                    </div>
                    <div class="col-md-3 text-center">
                        <h4>{{ "%.1f"|format(county_insights.avg_flippability_score) }}</h4>
                        <p class="text-muted">Avg Flippability</p>
                    </div>
                    <div class="col-md-3 text-center">
                        <h4>{{ county_insights.cluster_distribution|length }}</h4>
                        <p class="text-muted">Active Clusters</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Actions Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-tasks"></i> Available Actions</h5>
            </div>
            <div class="card-body">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-primary" onclick="refreshClusteringData()">
                        <i class="fas fa-sync-alt"></i> Refresh Analysis
                    </button>
                    {% if user.is_admin %}
                    <button type="button" class="btn btn-warning" onclick="updateFlippableRaces()">
                        <i class="fas fa-plus"></i> Update Flippable Races
                    </button>
                    {% endif %}
                    <a href="/precinct_clustering_results.csv" class="btn btn-outline-secondary" download>
                        <i class="fas fa-download"></i> Download Data
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Chart.js integration for cluster visualization
document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/clustering/data')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('clusterChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data.cluster_distribution).map(k => `Cluster ${k}`),
                    datasets: [{
                        data: Object.values(data.cluster_distribution),
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                            '#9966FF', '#FF9F40', '#FF6384'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Precinct Distribution by Cluster'
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error loading chart data:', error);
            document.getElementById('clusterChart').style.display = 'none';
        });
});

function refreshClusteringData() {
    location.reload();
}

{% if user.is_admin %}
function updateFlippableRaces() {
    if (confirm('Search for new flippable races and update the database?')) {
        alert('Feature coming soon: This will trigger the flippable races update script.');
    }
}
{% endif %}
</script>

<style>
.stat-box {
    padding: 1rem;
    border-radius: 8px;
    background-color: #f8f9fa;
    margin-bottom: 1rem;
}

.stat-box h3 {
    margin-bottom: 0.5rem;
    font-weight: bold;
}
</style>

{% endblock %}