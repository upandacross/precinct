{% extends "base.html" %}

{% block title %}Precinct Clustering Analysis - Precinct Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-8">
        <h1><i class="fas fa-project-diagram"></i> Precinct Clustering Analysis</h1>
        <p class="lead">Strategic insights from precinct and demographic clustering analysis</p>
    </div>
    <div class="col-4 d-flex justify-content-end align-items-start">
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Go Back
        </a>
    </div>
</div>

<!-- User Precinct Insights -->
{% if user_insights %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-map-marker-alt"></i> Your Precinct: {{ user_insights.county }} - {{ user_insights.precinct }}</h5>
                <small class="text-light">{{ user_insights.election_date_range }}</small>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-2">
                        <div class="stat-box text-center">
                            <h3 class="text-primary">{{ user_insights.comprehensive_cluster }}</h3>
                            <p class="text-muted">
                                Cluster Assignment
                                <span class="info-icon" 
                                      data-bs-toggle="tooltip" 
                                      data-bs-placement="bottom" 
                                      title="Statistical grouping based on geographic, political, and demographic similarities. Higher numbers often indicate priority organizing targets.">ⓘ</span>
                            </p>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-box text-center">
                            <h3 class="text-info">{{ "%.1f"|format(user_insights.area_km2) }}</h3>
                            <p class="text-muted">
                                Area (km²)
                                <span class="info-icon" 
                                      data-bs-toggle="tooltip" 
                                      data-bs-placement="bottom" 
                                      title="Geographic size of the precinct in square kilometers. Larger precincts may require different organizing strategies.">ⓘ</span>
                            </p>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-box text-center">
                            {% if user_insights.dem_vote_pct >= 60 %}
                                <h3 class="text-success">{{ "%.1f"|format(user_insights.dem_vote_pct) }}%</h3>
                            {% elif user_insights.dem_vote_pct >= 40 %}
                                <h3 class="text-warning">{{ "%.1f"|format(user_insights.dem_vote_pct) }}%</h3>
                            {% else %}
                                <h3 class="text-danger">{{ "%.1f"|format(user_insights.dem_vote_pct) }}%</h3>
                            {% endif %}
                            <p class="text-muted mb-1">Dem Vote %</p>
                            <div>
                                <span class="info-icon" 
                                      data-bs-toggle="tooltip" 
                                      data-bs-placement="bottom" 
                                      title="Percentage of votes within this precinct that went to Democratic candidates. This measures Democratic support within the precinct, not the precinct's share of county-wide Democratic votes.">ⓘ</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-box text-center">
                            {% if user_insights.dem_race_win_pct >= 60 %}
                                <h3 class="text-success">{{ "%.0f"|format(user_insights.dem_race_win_pct) }}%</h3>
                            {% elif user_insights.dem_race_win_pct >= 40 %}
                                <h3 class="text-warning">{{ "%.0f"|format(user_insights.dem_race_win_pct) }}%</h3>
                            {% else %}
                                <h3 class="text-danger">{{ "%.0f"|format(user_insights.dem_race_win_pct) }}%</h3>
                            {% endif %}
                            <p class="text-muted mb-1">Dem Race Win %</p>
                            <div>
                                <span class="info-icon" 
                                      data-bs-toggle="tooltip" 
                                      data-bs-placement="bottom" 
                                      title="Percentage of races actually won by Democratic candidates in this precinct. Democrats can win races even with lower overall vote share due to multi-candidate races, uncontested elections, or varying competition levels across different race types.">ⓘ</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-box text-center">
                            <h3 class="text-success">{{ "%.0f"|format(user_insights.flippability_score) }}</h3>
                            <p class="text-muted mb-1">Flippability Score</p>
                            <div>
                                <span class="info-icon" 
                                      data-bs-toggle="tooltip" 
                                      data-bs-placement="bottom" 
                                      title="Measures potential for flipping Republican-held races. Higher scores indicate more winnable contests. Zero means Democrats already win most races.">ⓘ</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-box text-center">
                            {% if user_insights.strategic_priority.startswith('Tier 1') %}
                                <span class="badge bg-danger fs-6">HIGH PRIORITY</span>
                            {% elif user_insights.strategic_priority.startswith('Tier 2') %}
                                <span class="badge bg-warning fs-6">MEDIUM PRIORITY</span>
                            {% else %}
                                <span class="badge bg-info fs-6">DATA TARGET</span>
                            {% endif %}
                            <p class="text-muted mt-2 mb-1">Strategic Priority</p>
                            <div>
                                <span class="info-icon" 
                                      data-bs-toggle="tooltip" 
                                      data-bs-placement="bottom" 
                                      title="Organizing priority based on data completeness and competitiveness. Tier 1 = High impact targets, Tier 2 = Medium priority, Data Target = Need more information.">ⓘ</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <strong>Strategic Classification:</strong> {{ user_insights.strategic_priority }}
                            <br>
                            <strong>Political Context:</strong> 
                            {% if user_insights.dem_race_win_pct >= 80 %}
                                Strong Democratic performance ({{ "%.0f"|format(user_insights.dem_race_win_pct) }}% race wins, {{ "%.1f"|format(user_insights.dem_vote_pct) }}% vote share) - 
                                {% if user_insights.flippability_score == 0 %}
                                    Likely Democratic stronghold, focus on turnout
                                {% else %}
                                    Maintain momentum with voter registration
                                {% endif %}
                            {% elif user_insights.dem_race_win_pct >= 50 %}
                                Competitive Democratic performance ({{ "%.0f"|format(user_insights.dem_race_win_pct) }}% race wins, {{ "%.1f"|format(user_insights.dem_vote_pct) }}% vote share) - 
                                {% if user_insights.flippability_score > 0 %}
                                    High-value organizing target with {{ "%.0f"|format(user_insights.flippability_score) }} flippability score
                                {% else %}
                                    Focus on maintaining wins and expanding margins
                                {% endif %}
                            {% else %}
                                Republican-leaning area ({{ "%.0f"|format(user_insights.dem_race_win_pct) }}% race wins, {{ "%.1f"|format(user_insights.dem_vote_pct) }}% vote share) - 
                                {% if user_insights.flippability_score > 0 %}
                                    Challenging but some flippable races available
                                {% else %}
                                    Long-term organizing and persuasion opportunity
                                {% endif %}
                            {% endif %}
                            <br>
                            <strong>Data Availability:</strong> 
                            {% if user_insights.has_political_data and user_insights.has_flippable_data %}
                                Complete data available (Political + Flippable)
                            {% elif user_insights.has_political_data %}
                                Political data available
                            {% else %}
                                Spatial data only
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i> 
            Your precinct information is not available in the clustering analysis. 
            Please ensure your profile has correct precinct and county information.
        </div>
    </div>
</div>
{% endif %}

<!-- Cluster Analysis Summary -->
{% if cluster_summary %}
<div class="row mt-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                {% if cluster_summary.user_cluster is defined %}
                <h5><i class="fas fa-users"></i> Your Cluster Analysis (Cluster {{ cluster_summary.user_cluster }})</h5>
                {% else %}
                <h5><i class="fas fa-chart-pie"></i> Clustering Overview</h5>
                {% endif %}
            </div>
            <div class="card-body">
                {% if cluster_summary.user_cluster is defined %}
                <!-- User-specific cluster analysis -->
                <div class="row">
                    <div class="col-md-3 text-center">
                        <h4 class="text-primary">{{ cluster_summary.cluster_size }}</h4>
                        <p class="text-muted mb-1">Precincts in Your Cluster</p>
                        <div>
                            <span class="info-icon" 
                                  data-bs-toggle="tooltip" 
                                  data-bs-placement="bottom" 
                                  title="Total number of precincts grouped with yours based on similar characteristics like size, demographics, and voting patterns.">ⓘ</span>
                        </div>
                        <small class="text-muted">{{ cluster_summary.cluster_percentage }}% of total</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <h4 class="text-success">{{ cluster_summary.precincts_with_political_data }}</h4>
                        <p class="text-muted mb-1">With Political Data</p>
                        <div>
                            <span class="info-icon" 
                                  data-bs-toggle="tooltip" 
                                  data-bs-placement="bottom" 
                                  title="Number of precincts in your cluster that have voting records and election results available for analysis.">ⓘ</span>
                        </div>
                        <small class="text-muted">Out of {{ cluster_summary.cluster_size }} total</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <h4 class="text-info">{{ cluster_summary.precincts_with_flippable_data }}</h4>
                        <p class="text-muted mb-1">Flippable Races</p>
                        <div>
                            <span class="info-icon" 
                                  data-bs-toggle="tooltip" 
                                  data-bs-placement="bottom" 
                                  title="Number of precincts in your cluster with identified competitive races that could potentially be won by Democrats with targeted effort.">ⓘ</span>
                        </div>
                        <small class="text-muted">Competitive opportunities</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <h4 class="text-warning">{{ "%.0f"|format(cluster_summary.avg_flippability_score) }}</h4>
                        <p class="text-muted mb-1">Avg Flippability</p>
                        <div>
                            <span class="info-icon" 
                                  data-bs-toggle="tooltip" 
                                  data-bs-placement="bottom" 
                                  title="Average flippability score across your cluster. Higher scores indicate more winnable Republican-held seats. Zero means Democrats already control most races.">ⓘ</span>
                        </div>
                        <small class="text-muted">Cluster average</small>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <strong>Strategic Focus:</strong> {{ cluster_summary.strategic_focus }}
                        </div>
                    </div>
                </div>
                {% else %}
                <!-- Overall summary (admin view) -->
                <div class="row">
                    <div class="col-md-3 text-center">
                        <h4 class="text-primary">{{ cluster_summary.total_precincts }}</h4>
                        <p class="text-muted">Total Precincts</p>
                    </div>
                    <div class="col-md-3 text-center">
                        <h4 class="text-success">{{ cluster_summary.high_priority_precincts }}</h4>
                        <p class="text-muted">High Priority</p>
                    </div>
                    <div class="col-md-3 text-center">
                        <h4 class="text-info">{{ cluster_summary.precincts_with_political_data }}</h4>
                        <p class="text-muted">With Political Data</p>
                    </div>
                    <div class="col-md-3 text-center">
                        <h4 class="text-warning">{{ cluster_summary.precincts_with_flippable_data }}</h4>
                        <p class="text-muted">With Flippable Data</p>
                    </div>
                </div>
                {% endif %}
                
                <!-- Cluster Distribution Chart -->
                <div class="mt-4">
                    <canvas id="clusterChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                {% if cluster_summary.user_cluster is defined %}
                <h5><i class="fas fa-target"></i> Your Cluster Strategy</h5>
                {% else %}
                <h5><i class="fas fa-bullseye"></i> Strategic Actions</h5>
                {% endif %}
            </div>
            <div class="card-body">
                {% if cluster_summary.user_cluster is defined %}
                <!-- User-specific strategic actions -->
                <div class="list-group list-group-flush">
                    <div class="list-group-item">
                        <strong>Your Priority Level:</strong><br>
                        {% if cluster_summary.is_high_priority %}
                        <span class="badge bg-danger">HIGH PRIORITY</span>
                        <small class="d-block mt-1">Cluster {{ cluster_summary.user_cluster }} - Strategic target</small>
                        {% else %}
                        <span class="badge bg-warning">MEDIUM PRIORITY</span>
                        <small class="d-block mt-1">Cluster {{ cluster_summary.user_cluster }} - Development focus</small>
                        {% endif %}
                    </div>
                    <div class="list-group-item">
                        <strong>Cluster Characteristics:</strong><br>
                        <small>{{ cluster_summary.cluster_size }} precincts ({{ cluster_summary.cluster_percentage }}% of total)</small><br>
                        <small>Average area: {{ cluster_summary.avg_area }} km²</small>
                    </div>
                    <div class="list-group-item">
                        <strong>Recommended Action:</strong><br>
                        <small>{{ cluster_summary.strategic_focus }}</small>
                    </div>
                </div>
                {% else %}
                <!-- Overall strategic actions (admin view) -->
                <div class="list-group list-group-flush">
                    <div class="list-group-item">
                        <strong>Tier 1 Priority:</strong><br>
                        <small>Clusters 3, 5, 6 - Complete data</small>
                    </div>
                    <div class="list-group-item">
                        <strong>Tier 2 Priority:</strong><br>
                        <small>Cluster 1 - Largest segment</small>
                    </div>
                    <div class="list-group-item">
                        <strong>Tier 3 Opportunity:</strong><br>
                        <small>Data collection targets</small>
                    </div>
                </div>
                {% endif %}
                
                <div class="mt-3">
                    <a href="{{ url_for('serve_documentation', filename='PRECINCT_CLUSTERING_SUMMARY.md') }}" 
                       class="btn btn-outline-primary btn-sm" target="_blank">
                        <i class="fas fa-file-alt"></i> Full Analysis Report
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- County Insights -->
{% if county_insights %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-map"></i> {{ user.county }} County Analysis</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 text-center">
                        <h4>{{ county_insights.total_precincts }}</h4>
                        <p class="text-muted">County Precincts</p>
                    </div>
                    <div class="col-md-3 text-center">
                        <h4>{{ county_insights.priority_precincts }}</h4>
                        <p class="text-muted">Priority Targets</p>
                    </div>
                    <div class="col-md-3 text-center">
                        <h4>{{ "%.1f"|format(county_insights.avg_flippability_score) }}</h4>
                        <p class="text-muted">Avg Flippability</p>
                    </div>
                    <div class="col-md-3 text-center">
                        <h4>{{ county_insights.cluster_distribution|length }}</h4>
                        <p class="text-muted">Active Clusters</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Chart.js integration for cluster visualization
document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/clustering/data')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('clusterChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data.cluster_distribution).map(k => `Cluster ${k}`),
                    datasets: [{
                        data: Object.values(data.cluster_distribution),
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                            '#9966FF', '#FF9F40', '#FF6384'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Precinct Distribution by Cluster'
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error loading chart data:', error);
            document.getElementById('clusterChart').style.display = 'none';
        });
});

// Initialize Bootstrap tooltips
document.addEventListener('DOMContentLoaded', function() {
    // Bootstrap 5 tooltip initialization
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl, {
            trigger: 'hover focus',
            delay: { show: 300, hide: 100 }
        });
    });
});
</script>

<style>
.stat-box {
    padding: 1rem;
    border-radius: 8px;
    background-color: #f8f9fa;
    margin-bottom: 1rem;
}

.stat-box h3 {
    margin-bottom: 0.5rem;
    font-weight: bold;
}

.info-icon {
    color: #6c757d;
    cursor: help;
    font-size: 14px;
    margin-left: 4px;
    display: inline-block;
    border-radius: 50%;
    width: 16px;
    height: 16px;
    text-align: center;
    line-height: 16px;
    font-weight: bold;
    border: 1px solid #6c757d;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

.info-icon:hover {
    color: #495057;
    border-color: #495057;
    background-color: #e9ecef;
}
</style>

{% endblock %}