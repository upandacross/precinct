{% extends "base.html" %}

{% block title %}Website User Report - Precinct Leaders App{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-users"></i> Website User Report</h1>
        <p class="lead">Comprehensive analytics for registered website users</p>
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> <strong>Scope:</strong> {{ user_stats.scope_description }}
        </div>
    </div>
</div>

<!-- User Statistics Overview -->
<div class="row mt-4">
    <div class="col-md-2">
        <div class="card text-center">
            <div class="card-body" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h3>{{ user_stats.total }}</h3>
                <p><i class="fas fa-users"></i> Total Users</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-2">
        <div class="card text-center">
            <div class="card-body" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                <h3>{{ user_stats.active }}</h3>
                <p><i class="fas fa-user-check"></i> Active</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-2">
        <div class="card text-center">
            <div class="card-body" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                <h3>{{ user_stats.admin }}</h3>
                <p><i class="fas fa-user-shield"></i> Admins</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-2">
        <div class="card text-center">
            <div class="card-body" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
                <h3>{{ user_stats.county }}</h3>
                <p><i class="fas fa-map-marker-alt"></i> County</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-2">
        <div class="card text-center">
            <div class="card-body" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white;">
                <h3>{{ user_stats.regular }}</h3>
                <p><i class="fas fa-user"></i> Regular</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-2">
        <div class="card text-center">
            <div class="card-body" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333;">
                <h3>{{ user_stats.recent }}</h3>
                <p><i class="fas fa-user-plus"></i> New (30d)</p>
            </div>
        </div>
    </div>
</div>

<!-- User Type Distribution Chart -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-pie"></i> User Type Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="userTypeChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-pie"></i> User Status Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="userStatusChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Monthly Signups Chart -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-line"></i> Monthly User Signups</h5>
            </div>
            <div class="card-body">
                <canvas id="monthlySignupsChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Precinct Organization Overview -->
{% if user_stats.precinct_distribution %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-map"></i> Precinct Organization Status</h5>
                <div>
                    {% set organized_count = user_stats.precinct_distribution.values() | list | select("greaterthan", 0) | list | length %}
                    {% set total_precincts = user_stats.precinct_distribution | length %}
                    <span class="badge bg-success">{{ organized_count }} Organized</span>
                    <span class="badge bg-warning">{{ total_precincts - organized_count }} No Users</span>
                </div>
            </div>
            <div class="card-body">
                <!-- Legend -->
                <div class="mb-3">
                    <small class="text-muted">
                        <i class="fas fa-circle text-success"></i> Organized (has registered users) â€¢ 
                        <i class="fas fa-circle text-warning"></i> No Users (no registered users)
                    </small>
                </div>
                
                <div class="row">
                    {% for precinct, count in user_stats.precinct_distribution.items() %}
                        <div class="col-md-3 mb-2">
                            {% if count > 0 %}
                                <div class="d-flex justify-content-between align-items-center p-2 rounded border-start border-success border-3" style="background-color: #d4edda;">
                                    <span><strong>Precinct {{ precinct }}:</strong></span>
                                    <span class="badge bg-success">{{ count }} user{{ 's' if count != 1 else '' }}</span>
                                </div>
                            {% else %}
                                <div class="d-flex justify-content-between align-items-center p-2 rounded border-start border-warning border-3" style="background-color: #fff3cd;">
                                    <span><strong>Precinct {{ precinct }}:</strong></span>
                                    <span class="badge bg-warning text-dark">No Users</span>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
                
                <!-- Summary Statistics -->
                <div class="mt-3 pt-3 border-top">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="text-success">
                                <h4>{{ organized_count }}</h4>
                                <small>Organized Precincts</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-warning">
                                <h4>{{ total_precincts - organized_count }}</h4>
                                <small>No Users</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-primary">
                                <h4>{{ "%.1f" | format((organized_count / total_precincts * 100) if total_precincts > 0 else 0) }}%</h4>
                                <small>Organization Rate</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-info">
                                <h4>{{ user_stats.precinct_distribution.values() | sum }}</h4>
                                <small>Total Precinct Users</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Administrative Actions -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-tools"></i> Administrative Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center flex-wrap">
                    <div class="d-flex gap-2 flex-wrap">
                        {% if user.is_admin %}
                            <a href="/admin/user" class="btn btn-outline-primary">
                                <i class="fas fa-users-cog"></i> Manage Users
                            </a>
                            <a href="{{ url_for('analysis') }}" class="btn btn-outline-success">
                                <i class="fas fa-chart-line"></i> Full Analytics Dashboard
                            </a>
                        {% endif %}
                        {% if not user.is_admin %}
                            <div class="text-muted">
                                <i class="fas fa-info-circle"></i> Additional admin functions available to administrators
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mt-2 mt-md-0">
                        <a href="/" class="btn btn-primary">
                            <i class="fas fa-arrow-left"></i> Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// User Type Distribution Chart
const userTypeCtx = document.getElementById('userTypeChart').getContext('2d');
const userTypeChart = new Chart(userTypeCtx, {
    type: 'doughnut',
    data: {
        labels: ['Regular Users', 'Administrators', 'County Coordinators'],
        datasets: [{
            data: [{{ user_stats.regular }}, {{ user_stats.admin }}, {{ user_stats.county }}],
            backgroundColor: [
                '#36a2eb',
                '#ff6384',
                '#ffce56'
            ],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// User Status Distribution Chart
const userStatusCtx = document.getElementById('userStatusChart').getContext('2d');
const userStatusChart = new Chart(userStatusCtx, {
    type: 'doughnut', 
    data: {
        labels: ['Active Users', 'Inactive Users'],
        datasets: [{
            data: [{{ user_stats.active }}, {{ user_stats.inactive }}],
            backgroundColor: [
                '#4bc0c0',
                '#ff9f40'
            ],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Monthly Signups Line Chart
const monthlySignupsCtx = document.getElementById('monthlySignupsChart').getContext('2d');
const monthlySignupsChart = new Chart(monthlySignupsCtx, {
    type: 'line',
    data: {
        labels: {{ user_stats.monthly_signups.labels | safe }},
        datasets: [{
            label: 'New User Registrations',
            data: {{ user_stats.monthly_signups.data }},
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: 'rgba(54, 162, 235, 1)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 6
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});
</script>

{% endblock %}