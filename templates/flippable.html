{% extends "base.html" %}

{% block title %}Flippable Races - Precinct Member's Application{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1><i class="fas fa-exchange-alt"></i> Flippable Races Analysis</h1>
                <p class="lead">Strategic analysis of winnable Democratic opportunities</p>
            </div>
            <div class="btn-group">
                {% if show_back_to_analysis %}
                    <a href="{{ url_for('flippable_analysis') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Analysis
                    </a>
                {% endif %}
                <button type="button" class="btn fw-bold" data-bs-toggle="modal" data-bs-target="#explanationModal" style="background-color: #dc3545 !important; border-color: #dc3545 !important; color: white !important;">
                    <i class="fas fa-question-circle"></i> Explanation
                </button>
            </div>
        </div>
        {% if target_county and target_precinct %}
        <div class="alert alert-info">
            <i class="fas fa-map-marker-alt"></i> 
            Showing results for <strong>Precinct {{ target_precinct }}</strong>, {{ target_county }} County
        </div>
        {% elif current_user.county and current_user.precinct %}
        <div class="alert alert-info">
            <i class="fas fa-map-marker-alt"></i> 
            Showing results for <strong>Precinct {{ current_user.precinct }}</strong>, {{ current_user.county }} County
        </div>
        {% endif %}
    </div>
</div>

<!-- Assessment Categories Overview -->
<div class="row mt-4">
    <div class="col-12">
        <h3><i class="fas fa-chart-pie"></i> Assessment Categories</h3>
        <div class="row">
            {% for category, count in assessment_counts.items() %}
            <div class="col-md-3 mb-3">
                <div class="card {% if 'üéØ' in category %}bg-success{% elif '‚úÖ' in category %}bg-primary{% elif 'üü°' in category %}bg-warning{% else %}bg-danger{% endif %} text-white">
                    <div class="card-body text-center">
                        <h2 class="card-title">{{ category }}</h2>
                        <h1 class="display-4">{{ count }}</h1>
                        <p class="card-text">
                            {% if 'üéØ' in category %}
                                Weekend volunteer effort
                            {% elif '‚úÖ' in category %}
                                Month-long focused campaign
                            {% elif 'üü°' in category %}
                                Season-long strategic effort
                            {% else %}
                                Multi-cycle investment
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- No Flippable Races Message -->
{% if not races or races|length == 0 %}
<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-success border-success" style="border-width: 3px !important;">
            <div class="row align-items-center">
                <div class="col-md-2 text-center">
                    <i class="fas fa-trophy fa-3x text-success"></i>
                </div>
                <div class="col-md-10">
                    <h4 class="alert-heading mb-3">
                        <i class="fas fa-check-circle"></i> Excellent Democratic Performance!
                    </h4>
                    <p class="mb-2">
                        <strong>All flippable categories show 0 because Democrats won all the competitive races in this precinct.</strong>
                    </p>
                    <p class="mb-3">
                        This means there are no Republican-held seats to flip - Democrats are already winning! 
                        Your precinct demonstrates strong Democratic voter turnout and engagement.
                    </p>
                    <hr class="my-3">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-shield-alt text-success"></i> <strong>Focus on Defense:</strong></h6>
                            <ul class="mb-0">
                                <li>Maintain current voter engagement</li>
                                <li>Continue voter registration efforts</li>
                                <li>Support Democratic incumbents</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-hands-helping text-primary"></i> <strong>Help Other Areas:</strong></h6>
                            <ul class="mb-0">
                                <li>Share successful strategies with other precincts</li>
                                <li>Support nearby competitive districts</li>
                                <li>Consider volunteering in swing precincts</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Strategy Guide -->
<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-info">
            <h5><i class="fas fa-lightbulb"></i> Strategy Guide</h5>
            <div class="row">
                <div class="col-md-6">
                    <strong>üìà Traditional Pathway:</strong> Focus on voter registration, door-to-door outreach, and expanding Democratic turnout
                </div>
                <div class="col-md-6">
                    <strong>üèõÔ∏è DVA Pathway:</strong> Mobilize Democratic voters who voted for governor but skipped down-ballot races
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Races Table -->
{% if races and races|length > 0 %}
<div class="row mt-4">
    <div class="col-12">
        <h3><i class="fas fa-table"></i> Race Details</h3>
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="flippableTable">
                <thead class="table-dark">
                    <tr>
                        <th>Assessment</th>
                        <th>County</th>
                        <th>Precinct</th>
                        <th>Contest</th>
                        <th>Election</th>
                        <th>Vote Gap</th>
                        <th>DVA %</th>
                        <th>Best Pathway</th>
                        <th>Dem Votes</th>
                        <th>Opp Votes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for race in races %}
                    <tr class="{% if 'üéØ' in race.assessment %}table-success{% elif '‚úÖ' in race.assessment %}table-primary{% elif 'üü°' in race.assessment %}table-warning{% else %}table-danger{% endif %}">
                        <td>
                            <span class="badge {% if 'üéØ' in race.assessment %}bg-success{% elif '‚úÖ' in race.assessment %}bg-primary{% elif 'üü°' in race.assessment %}bg-warning{% else %}bg-danger{% endif %}">
                                {{ race.assessment }}
                            </span>
                        </td>
                        <td>{{ race.county }}</td>
                        <td>{{ race.precinct }}</td>
                        <td>{{ race.contest_name }}</td>
                        <td>{{ race.election_date }}</td>
                        <td>
                            <strong>{{ race.vote_gap }}</strong> votes
                        </td>
                        <td>
                            {% if race.dva_pct_needed is none or race.dva_pct_needed < 0 or race.dva_pct_needed >= 999 %}
                                <span class="text-dark">N/A</span>
                            {% elif race.dva_pct_needed >= 100 %}
                                <span class="text-warning">{{ race.dva_pct_needed|round(1) }}%</span>
                            {% else %}
                                <span class="text-success">{{ race.dva_pct_needed|round(1) }}%</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if race.best_pathway == 'DVA' %}
                                <span class="badge bg-info">üèõÔ∏è DVA</span>
                            {% else %}
                                <span class="badge bg-secondary">üìà Traditional</span>
                            {% endif %}
                        </td>
                        <td>{{ "{:,}".format(race.dem_votes|int) if race.dem_votes else 0 }}</td>
                        <td>{{ "{:,}".format(race.oppo_votes|int) if race.oppo_votes else 0 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% else %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> No Flippable Races Found</h5>
            </div>
            <div class="card-body">
                <p class="mb-3">
                    No Republican-held races were found for this precinct that meet the flippable criteria. 
                    This typically means one of the following:
                </p>
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-trophy text-success"></i> Strong Democratic Performance</h6>
                        <ul>
                            <li>Democrats won all competitive races</li>
                            <li>No Republican seats available to flip</li>
                            <li>Precinct shows solid Democratic support</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-chart-line text-primary"></i> Other Possibilities</h6>
                        <ul>
                            <li>Races may be uncontested</li>
                            <li>Vote margins too large for flipping</li>
                            <li>Limited down-ballot competition</li>
                        </ul>
                    </div>
                </div>
                <div class="alert alert-light mt-3">
                    <strong>üí° Tip:</strong> Try viewing the <strong>Flippable Analysis</strong> page for a county-wide overview 
                    of strategic opportunities across all precincts.
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Key Insights -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-key"></i> Key Insights</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6>üéØ Priority Focus</h6>
                        <p>Start with <strong>SLAM DUNK</strong> and <strong>HIGHLY FLIPPABLE</strong> races for quick wins and momentum building.</p>
                    </div>
                    <div class="col-md-4">
                        <h6>üìä Resource Allocation</h6>
                        <p>Use the <strong>Best Pathway</strong> column to determine whether traditional outreach or DVA mobilization is more effective.</p>
                    </div>
                    <div class="col-md-4">
                        <h6>üóìÔ∏è Timeline Planning</h6>
                        <p>Factor in the <strong>effort level</strong> when planning campaign timelines and volunteer recruitment.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Explanation Modal -->
<div class="modal fade" id="explanationModal" tabindex="-1" aria-labelledby="explanationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="text-shadow: none;">
                <h5 class="modal-title text-dark" id="explanationModalLabel" style="text-shadow: none;">
                    <i class="fas fa-info-circle"></i> Flippable Races Analysis Explanation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-dark" style="text-shadow: none;">
                <div class="row">
                    <div class="col-12" style="text-shadow: none;">
                        <h6 style="text-shadow: none;"><i class="fas fa-bullseye"></i> What are Flippable Races?</h6>
                        <p style="text-shadow: none;">Flippable races are competitive elections where the Opposition currently wins, but could potentially be won by Democrats through strategic voter mobilization.</p>
                        
                        <h6 style="text-shadow: none;"><i class="fas fa-chart-line"></i> Key Terms</h6>
                        <ul style="text-shadow: none;">
                            <li style="text-shadow: none;"><strong>Vote Gap:</strong> The number of additional votes Democrats need to win (Opposition votes + 1 - Democratic votes)</li>
                            <li style="text-shadow: none;"><strong>Democratic Vote Absences:</strong> Democratic voters who voted for governor but skipped down-ballot races</li>
                            <li style="text-shadow: none;"><strong>DVA (Democratic Vote Absences):</strong> The percentage of absent Democratic voters needed to flip the race</li>
                            <li style="text-shadow: none;"><strong>DVA Strategy:</strong> Mobilizing voters who are already in the voting booth and vote for the Democrat governor candidate</li>
                            <li style="text-shadow: none;"><strong>Traditional Strategy:</strong> Voter registration, turnout drives, and general mobilization</li>
                        </ul>
                        
                        <h6 style="text-shadow: none;"><i class="fas fa-calculator"></i> How DVA is Calculated</h6>
                        <p style="text-shadow: none;"><code style="text-shadow: none;">DVA % = (Votes Needed to Win) / (Available Democratic Voters) √ó 100</code></p>
                        <p style="text-shadow: none;">Where:</p>
                        <ul style="text-shadow: none;">
                            <li style="text-shadow: none;"><strong>Votes Needed to Win:</strong> (Opposition votes + 1) - Democratic votes</li>
                            <li style="text-shadow: none;"><strong>Available Democratic Voters:</strong> Governor votes - Race votes (Democrats who voted governor but skipped this race)</li>
                        </ul>
                        
                        <h6 style="text-shadow: none;"><i class="fas fa-question"></i> Why Does DVA Show 'N/A'?</h6>
                        <p style="text-shadow: none;">DVA shows 'N/A' when there are no available Democratic voters to mobilize (when governor votes ‚â§ race votes). This means every Democrat who voted for governor also voted in this race, so the DVA strategy doesn't apply. However, <strong>traditional voter mobilization strategies may still work</strong>.</p>
                        
                        <h6 style="text-shadow: none;"><i class="fas fa-trophy"></i> Assessment Categories</h6>
                        <ul style="text-shadow: none;">
                            <li style="text-shadow: none;"><strong>üéØ Slam Dunk:</strong> ‚â§25 vote gap or ‚â§15% DVA - achievable with weekend effort</li>
                            <li style="text-shadow: none;"><strong>‚úÖ Highly Flippable:</strong> ‚â§100 vote gap or ‚â§35% DVA - month-long focused campaign</li>
                            <li style="text-shadow: none;"><strong>üü° Competitive:</strong> Larger gaps but ‚â§50% DVA - sustained campaign effort</li>
                            <li style="text-shadow: none;"><strong>üî¥ Stretch Goal:</strong> Very difficult but theoretically possible</li>
                        </ul>
                        
                        <h6 style="text-shadow: none;"><i class="fas fa-route"></i> Best Pathway</h6>
                        <ul style="text-shadow: none;">
                            <li style="text-shadow: none;"><strong>üèõÔ∏è DVA:</strong> Focus on mobilizing absent Democratic voters</li>
                            <li style="text-shadow: none;"><strong>üìà Traditional:</strong> Focus on voter registration and general turnout</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Initialize DataTable with sorting and filtering
    $('#flippableTable').DataTable({
        "pageLength": 25,
        "order": [[ 0, "asc" ]], // Sort by assessment category
        "responsive": true,
        "columnDefs": [
            {
                "targets": [5, 6], // Vote Gap and DVA columns
                "type": "num"
            }
        ]
    });
});
</script>

{% endblock %}